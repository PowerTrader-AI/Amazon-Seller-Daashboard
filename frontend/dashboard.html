<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Sourcing Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            color: #60a5fa;
        }

        .header p {
            color: #94a3b8;
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            background: #1e293b;
            padding: 8px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .tab {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: #94a3b8;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover {
            background: #0f172a;
            color: #e2e8f0;
        }

        .tab.active {
            background: #2563eb;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            font-size: 20px;
            margin-bottom: 16px;
            color: #e2e8f0;
        }

        /* Category Tree Styles */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .category-card {
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-card:hover {
            border-color: #60a5fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
        }

        .category-card.recommended {
            border-color: #22c55e;
            background: linear-gradient(135deg, #0f172a 0%, #064e3b 100%);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .category-name {
            font-size: 16px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 4px;
        }

        .opportunity-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .opportunity-high {
            background: #22c55e;
            color: white;
        }

        .opportunity-medium {
            background: #f59e0b;
            color: white;
        }

        .opportunity-low {
            background: #64748b;
            color: white;
        }

        .category-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .metric {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .metric-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            font-weight: 600;
        }

        .metric-value {
            font-size: 16px;
            font-weight: 600;
            color: #e2e8f0;
        }

        .competition-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
        }

        .competition-low {
            background: #22c55e;
            color: white;
        }

        .competition-medium {
            background: #f59e0b;
            color: white;
        }

        .competition-high {
            background: #ef4444;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #60a5fa;
        }

        .spinner {
            border: 3px solid #334155;
            border-top: 3px solid #60a5fa;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #0f172a;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #334155;
        }

        .stat-label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #60a5fa;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 13px;
            color: #94a3b8;
            font-weight: 500;
        }

        .filter-group input,
        .filter-group select {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 10px 12px;
            color: #e2e8f0;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            border-color: #60a5fa;
        }

        /* Tooltip Styles */
        .category-card {
            position: relative;
        }

        .tooltip {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            background: #0f172a;
            border: 2px solid #60a5fa;
            border-radius: 12px;
            padding: 16px;
            min-width: 320px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
        }

        .category-card:hover .tooltip {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) translateY(-105%);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #60a5fa;
        }

        .tooltip-header {
            font-size: 14px;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #334155;
        }

        .tooltip-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .tooltip-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .tooltip-label {
            font-size: 10px;
            color: #94a3b8;
            text-transform: uppercase;
            font-weight: 600;
        }

        .tooltip-value {
            font-size: 14px;
            font-weight: 600;
            color: #e2e8f0;
        }

        .tooltip-value.good {
            color: #22c55e;
        }

        .tooltip-value.warning {
            color: #f59e0b;
        }

        .tooltip-value.bad {
            color: #ef4444;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Recommendations Table */
        .recommendations-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .recommendations-table th {
            background: #0f172a;
            padding: 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            border-bottom: 2px solid #334155;
        }

        .recommendations-table td {
            padding: 16px;
            border-bottom: 1px solid #334155;
            font-size: 14px;
        }

        .recommendations-table tr:hover {
            background: #0f172a;
        }

        .rank-badge {
            background: #2563eb;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 700;
            min-width: 40px;
            text-align: center;
        }

        .score-badge {
            font-size: 16px;
            font-weight: 700;
            padding: 8px 12px;
            border-radius: 6px;
            background: #1e293b;
        }

        .score-badge.excellent {
            color: #22c55e;
        }

        .score-badge.good {
            color: #60a5fa;
        }

        .score-badge.fair {
            color: #f59e0b;
        }

        .recommendation-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 12px;
            display: inline-block;
        }

        .recommendation-badge.buy {
            background: #22c55e;
            color: #000;
        }

        .recommendation-badge.analyse {
            background: #f59e0b;
            color: #000;
        }

        .recommendation-badge.avoid {
            background: #ef4444;
            color: white;
        }

        .risk-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 12px;
            display: inline-block;
        }

        .risk-badge.low {
            background: #22c55e;
            color: #000;
        }

        .risk-badge.medium {
            background: #f59e0b;
            color: #000;
        }

        .risk-badge.high {
            background: #ef4444;
            color: white;
        }

        .reason-text {
            font-size: 12px;
            color: #cbd5e1;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .action-items {
            font-size: 12px;
            color: #94a3b8;
            list-style: none;
        }

        .action-items li {
            margin: 4px 0;
            padding-left: 20px;
            position: relative;
        }

        .action-items li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: #60a5fa;
            font-weight: bold;
        }

        .expand-btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .expand-btn:hover {
            background: #1d4ed8;
        }

        .expanded-row {
            display: none;
        }

        .expanded-row.show {
            display: table-row;
        }

        .expanded-content {
            padding: 20px;
            background: #0f172a;
            border-left: 3px solid #2563eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Amazon Sourcing Dashboard</h1>
            <p>Analyze categories, discover opportunities, and find winning products</p>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('category')">
                üìä Category Explorer
            </button>
            <button class="tab" onclick="switchTab('recommendations')">
                ‚≠ê Recommendations
            </button>
            <button class="tab" onclick="switchTab('product')">
                üîç Product Analyzer
            </button>
            <button class="tab" onclick="switchTab('sourcing')">
                üéÅ My Shortlist (0)
            </button>
        </div>

        <!-- Category Explorer Tab -->
        <div id="categoryTab" class="tab-content active">
            <div class="card">
                <h2>üéÆ Toys & Games - Market Overview</h2>
                
                <div class="stats-row" id="categoryStats">
                    <div class="stat-card">
                        <div class="stat-label">Total Subcategories</div>
                        <div class="stat-value">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Products</div>
                        <div class="stat-value">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Price</div>
                        <div class="stat-value">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">High Opportunity</div>
                        <div class="stat-value" style="color: #22c55e;">-</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Subcategories Ranked by Opportunity</h2>
                <div id="categoryGrid" class="category-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading category data...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recommendations Tab -->
        <div id="recommendationsTab" class="tab-content">
            <div class="card">
                <h2>‚≠ê Smart Recommendations - What to Source</h2>
                <p style="color: #94a3b8; margin-bottom: 16px; font-size: 14px;">
                    AI-powered analysis identifying which categories have the best profit potential and lowest competition
                </p>
                <div id="recommendationsTable" style="overflow-x: auto;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading recommendations...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Analyzer Tab -->
        <div id="productTab" class="tab-content">
            <div class="card">
                <h2>Product Search & Analysis</h2>
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <h3>Product Analyzer Coming Soon</h3>
                    <p>Select products from Category Explorer to analyze in detail</p>
                </div>
            </div>
        </div>

        <!-- Sourcing Shortlist Tab -->
        <div id="sourcingTab" class="tab-content">
            <div class="card">
                <h2>My Sourcing Shortlist</h2>
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <h3>No Products Shortlisted Yet</h3>
                    <p>Start exploring categories to add products to your shortlist</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Load data if needed
            if (tabName === 'category') {
                loadCategoryData();
            } else if (tabName === 'recommendations') {
                loadRecommendations();
            } else if (tabName === 'sourcing') {
                loadShortlist();
            }
        }

        // Load category analysis data
        async function loadCategoryData() {
            try {
                const response = await fetch('/category/analysis');
                const data = await response.json();

                if (data.success) {
                    renderCategoryStats(data);
                    renderCategories(data.opportunities);
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                document.getElementById('categoryGrid').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: #ef4444; padding: 40px;">
                        <p>‚ö†Ô∏è Error loading category data</p>
                        <p style="font-size: 12px; margin-top: 8px;">${error.message}</p>
                    </div>
                `;
            }
        }

        function renderCategoryStats(data) {
            const stats = document.getElementById('categoryStats');
            const highOpportunity = data.opportunities.filter(c => c.recommended).length;
            const totalProducts = data.opportunities.reduce((sum, c) => sum + c.products, 0);
            const avgPrice = (data.opportunities.reduce((sum, c) => sum + c.avg_price, 0) / data.opportunities.length).toFixed(2);

            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Subcategories</div>
                    <div class="stat-value">${data.opportunities.length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Products</div>
                    <div class="stat-value">${totalProducts.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Price</div>
                    <div class="stat-value">‚Çπ${avgPrice}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">High Opportunity</div>
                    <div class="stat-value" style="color: #22c55e;">${highOpportunity}</div>
                </div>
            `;
        }

        function renderCategories(categories) {
            const grid = document.getElementById('categoryGrid');
            
            if (!categories || categories.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #94a3b8;">No categories found</p>';
                return;
            }

            grid.innerHTML = categories.map(cat => {
                const opportunityClass = cat.opportunity_score >= 80 ? 'high' : 
                                       cat.opportunity_score >= 60 ? 'medium' : 'low';
                const competitionClass = cat.competition.toLowerCase();
                const isRecommended = cat.recommended;
                
                // Calculate seller density for tooltip
                const sellerCount = cat.seller_count || 0;
                const sellerDensity = sellerCount > 0 ? ((sellerCount / cat.products) * 100).toFixed(2) : 'N/A';
                const avgReviewCount = cat.review_count || 'N/A';
                
                // Price sensitivity indicator
                const priceIndicator = cat.avg_price < 500 ? 'Low margin' : 
                                      cat.avg_price <= 2000 ? 'Sweet spot ‚úì' :
                                      cat.avg_price <= 3500 ? 'Price sensitive' : 
                                      'High price risk';
                const priceClass = cat.avg_price < 500 ? 'warning' : 
                                  cat.avg_price <= 2000 ? 'good' :
                                  cat.avg_price <= 3500 ? 'warning' : 'bad';
                
                // Seller competition indicator
                const sellerCompetition = sellerDensity === 'N/A' ? 'Unknown' :
                                         sellerDensity < 0.5 ? 'Very Low ‚úì‚úì' :
                                         sellerDensity < 1.5 ? 'Low ‚úì' :
                                         sellerDensity < 3 ? 'Medium' : 'High';
                const sellerClass = sellerDensity === 'N/A' ? '' :
                                   sellerDensity < 1.5 ? 'good' :
                                   sellerDensity < 3 ? 'warning' : 'bad';

                return `
                    <div class="category-card ${isRecommended ? 'recommended' : ''}" onclick="selectCategory('${cat.category_id}', '${cat.name}')">
                        <!-- Tooltip -->
                        <div class="tooltip">
                            <div class="tooltip-header">${cat.name} - Detailed Metrics</div>
                            <div class="tooltip-grid">
                                <div class="tooltip-item">
                                    <div class="tooltip-label">Total Products</div>
                                    <div class="tooltip-value">${cat.products.toLocaleString()}</div>
                                </div>
                                <div class="tooltip-item">
                                    <div class="tooltip-label">Total Sellers</div>
                                    <div class="tooltip-value">${sellerCount.toLocaleString()}</div>
                                </div>
                                <div class="tooltip-item">
                                    <div class="tooltip-label">Seller Density</div>
                                    <div class="tooltip-value ${sellerClass}">${sellerDensity}%</div>
                                </div>
                                <div class="tooltip-item">
                                    <div class="tooltip-label">Competition</div>
                                    <div class="tooltip-value ${sellerClass}">${sellerCompetition}</div>
                                </div>
                                <div class="tooltip-item">
                                    <div class="tooltip-label">Avg Price Range</div>
                                    <div class="tooltip-value ${priceClass}">‚Çπ${Math.round(cat.avg_price)}</div>
                                </div>
                                <div class="tooltip-item">
                                    <div class="tooltip-label">Price Level</div>
                                    <div class="tooltip-value ${priceClass}">${priceIndicator}</div>
                                </div>
                                <div class="tooltip-item">
                                    <div class="tooltip-label">Avg Reviews</div>
                                    <div class="tooltip-value">${avgReviewCount}</div>
                                </div>
                                <div class="tooltip-item">
                                    <div class="tooltip-label">FBA Adoption</div>
                                    <div class="tooltip-value ${cat.fba_share >= 80 ? 'good' : cat.fba_share >= 60 ? 'warning' : 'bad'}">${cat.fba_share}%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="category-header">
                            <div>
                                <div class="category-name">
                                    ${isRecommended ? '‚≠ê ' : ''}${cat.name}
                                </div>
                                <span class="competition-badge competition-${competitionClass}">
                                    ${cat.competition} Competition
                                </span>
                            </div>
                            <span class="opportunity-badge opportunity-${opportunityClass}">
                                ${Math.round(cat.opportunity_score)}
                            </span>
                        </div>
                        
                        <div class="category-metrics">
                            <div class="metric">
                                <div class="metric-label">Products</div>
                                <div class="metric-value">${cat.products.toLocaleString()}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Avg Price</div>
                                <div class="metric-value">‚Çπ${Math.round(cat.avg_price)}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Sales Rank</div>
                                <div class="metric-value">#${cat.sales_rank.toLocaleString()}</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">FBA Share</div>
                                <div class="metric-value">${cat.fba_share}%</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectCategory(categoryId, categoryName) {
            console.log('Selected category:', categoryId, categoryName);
            // TODO: Navigate to product analysis for this category
            alert(`Category selected: ${categoryName}\n\nNext: Fetch top products from this category for deep analysis`);
        }

        // Load and render recommendations
        async function loadRecommendations() {
            try {
                const response = await fetch('/category/analysis');
                const data = await response.json();

                if (data.success) {
                    renderRecommendationsTable(data.opportunities);
                }
            } catch (error) {
                console.error('Error loading recommendations:', error);
                document.getElementById('recommendationsTable').innerHTML = `
                    <div style="text-align: center; color: #ef4444; padding: 40px;">
                        <p>‚ö†Ô∏è Error loading recommendations</p>
                        <p style="font-size: 12px; margin-top: 8px;">${error.message}</p>
                    </div>
                `;
            }
        }

        function renderRecommendationsTable(opportunities) {
            const container = document.getElementById('recommendationsTable');
            
            if (!opportunities || opportunities.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8;">No opportunities found</p>';
                return;
            }

            let html = `
                <table class="recommendations-table">
                    <thead>
                        <tr>
                            <th style="width: 8%;">Rank</th>
                            <th style="width: 20%;">Category</th>
                            <th style="width: 10%;">Score</th>
                            <th style="width: 12%;">Recommendation</th>
                            <th style="width: 12%;">Risk</th>
                            <th style="width: 38%;">Reason & Next Steps</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            opportunities.forEach((opp, index) => {
                const rec = opp.recommendation || {};
                const score = opp.opportunity_score || 0;
                
                // Determine score color
                let scoreClass = 'fair';
                if (score >= 85) scoreClass = 'excellent';
                else if (score >= 70) scoreClass = 'good';

                // Determine recommendation badge color
                const recClass = (rec.recommendation || 'ANALYSE').toLowerCase();

                // Determine risk badge color
                const riskClass = (rec.risk_level || 'MEDIUM').toLowerCase();

                const reason = rec.reason || 'No details available';
                const actionItems = rec.action_items || [];

                const rowId = `rec-row-${index}`;
                const expandId = `expand-${index}`;

                html += `
                    <tr style="cursor: pointer;" onclick="selectCategoryAndAnalyze('${opp.category_id}', '${opp.name}')">
                        <td>
                            <div class="rank-badge">#${index + 1}</div>
                        </td>
                        <td>
                            <strong style="color: #60a5fa;">${opp.name}</strong>
                            <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">
                                ${opp.products.toLocaleString()} products | ${opp.seller_count} sellers
                            </div>
                        </td>
                        <td>
                            <div class="score-badge ${scoreClass}">${score.toFixed(1)}</div>
                        </td>
                        <td>
                            <div class="recommendation-badge ${recClass}">
                                ${rec.recommendation || 'ANALYSE'}
                            </div>
                        </td>
                        <td>
                            <div class="risk-badge ${riskClass}">
                                ${rec.risk_level || 'MEDIUM'}
                            </div>
                        </td>
                        <td>
                            <div class="reason-text">${reason}</div>
                            ${actionItems.length > 0 ? `
                                <ul class="action-items">
                                    ${actionItems.slice(0, 2).map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            ` : ''}
                            <button class="expand-btn" onclick="event.stopPropagation(); toggleExpanded('${expandId}')" style="margin-top: 8px;">
                                ‚Üí Expand
                            </button>
                        </td>
                    </tr>
                    <tr id="${expandId}" class="expanded-row">
                        <td colspan="6">
                            <div class="expanded-content">
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #60a5fa;">üìä Full Analysis:</strong>
                                    <div class="reason-text" style="margin-top: 8px;">${reason}</div>
                                </div>
                                <div>
                                    <strong style="color: #60a5fa;">üéØ Action Items:</strong>
                                    <ul class="action-items" style="margin-top: 8px;">
                                        ${actionItems.map(item => `<li>${item}</li>`).join('')}
                                    </ul>
                                </div>
                                <div style="margin-top: 12px;">
                                    <strong style="color: #60a5fa;">üìà Market Metrics:</strong>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 8px; font-size: 12px;">
                                        <div>
                                            <div style="color: #94a3b8; font-size: 11px;">Avg Price</div>
                                            <div style="color: #e2e8f0; font-weight: 600;">‚Çπ${opp.avg_price.toLocaleString()}</div>
                                        </div>
                                        <div>
                                            <div style="color: #94a3b8; font-size: 11px;">Avg Reviews</div>
                                            <div style="color: #e2e8f0; font-weight: 600;">${opp.review_count}</div>
                                        </div>
                                        <div>
                                            <div style="color: #94a3b8; font-size: 11px;">Avg Offers/Product</div>
                                            <div style="color: #e2e8f0; font-weight: 600;">${opp.avg_offers_per_product.toFixed(1)}</div>
                                        </div>
                                        <div>
                                            <div style="color: #94a3b8; font-size: 11px;">FBA Share</div>
                                            <div style="color: #e2e8f0; font-weight: 600;">${opp.fba_share}%</div>
                                        </div>
                                    </div>
                                </div>
                                <button class="expand-btn" onclick="event.stopPropagation(); toggleExpanded('${expandId}')" style="margin-top: 12px; background: #1e293b; color: #94a3b8;">
                                    ‚Üê Collapse
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function toggleExpanded(expandId) {
            const row = document.getElementById(expandId);
            if (row) {
                row.classList.toggle('show');
            }
        }

        // Select category and switch to product analyzer
        async function selectCategoryAndAnalyze(categoryId, categoryName) {
            console.log('Analyzing category:', categoryId, categoryName);
            
            // Switch to product tab
            switchTab('product');
            
            // Fetch and display products
            loadCategoryProducts(categoryId, categoryName);
        }

        // Load products for a specific category
        async function loadCategoryProducts(categoryId, categoryName) {
            try {
                const productTab = document.getElementById('productTab');
                productTab.innerHTML = `
                    <div class="card">
                        <h2>üîç Analyzing: ${categoryName}</h2>
                        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                            <div style="flex: 1;">
                                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 4px;">Category ID</div>
                                <div style="color: #e2e8f0; font-weight: 600;">${categoryId}</div>
                            </div>
                            <div style="flex: 1;">
                                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 4px;">Status</div>
                                <div style="color: #60a5fa; font-weight: 600;">‚è≥ Fetching products...</div>
                            </div>
                        </div>
                        <div id="productsContainer" class="loading">
                            <div class="spinner"></div>
                            <p>Fetching top products from Keepa...</p>
                        </div>
                    </div>
                `;

                // Fetch products from backend
                const response = await fetch(`/category/products/${categoryId}?per_page=50&page=0`);
                const data = await response.json();

                if (data.success && data.products && data.products.length > 0) {
                    renderProductList(data.products, categoryName);
                } else {
                    document.getElementById('productsContainer').innerHTML = `
                        <div style="text-align: center; color: #f59e0b; padding: 40px;">
                            <p>‚ö†Ô∏è No products found in this category</p>
                            <p style="font-size: 12px; margin-top: 8px; color: #94a3b8;">
                                ${data.total_results ? `(${data.total_results} total, but details unavailable)` : 'Category may be empty'}
                            </p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('productsContainer').innerHTML = `
                    <div style="text-align: center; color: #ef4444; padding: 40px;">
                        <p>‚ö†Ô∏è Error fetching products</p>
                        <p style="font-size: 12px; margin-top: 8px;">${error.message}</p>
                    </div>
                `;
            }
        }

        // Render product list
        function renderProductList(products, categoryName) {
            const container = document.getElementById('productsContainer');
            
            if (!products || products.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">No unbranded products found. Try a different category or adjust filters.</p>';
                return;
            }

            let html = `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">`;

            products.forEach((product, index) => {
                const price = product.current_price ? (product.current_price / 100).toFixed(0) : 'N/A';
                const rating = product.rating ? `‚≠ê ${product.rating}` : '‚≠ê No rating';
                const reviews = product.reviews ? product.reviews.toLocaleString() : '0';
                const sellers = product.sellers || 'N/A';
                const rank = product.sales_rank && product.sales_rank < 999999 ? product.sales_rank.toLocaleString() : 'N/A';
                const opportunity = product.opportunity_score || 0;

                // Opportunity score color
                let oppColor = '#ef4444';  // Red (low)
                if (opportunity >= 70) oppColor = '#22c55e';  // Green (high)
                else if (opportunity >= 50) oppColor = '#f59e0b';  // Amber (medium)

                html += `
                    <div style="background: #1e293b; border-radius: 12px; padding: 16px; position: relative; border: 1px solid #334155; transition: all 0.2s;">
                        <div style="position: absolute; top: 12px; right: 12px; display: flex; gap: 8px;">
                            <div style="background: #2563eb; color: white; padding: 4px 10px; border-radius: 4px; font-size: 10px; font-weight: 600;">#${index + 1}</div>
                            <div style="background: ${oppColor}; color: ${opportunity >= 50 ? '#000' : '#fff'}; padding: 4px 10px; border-radius: 4px; font-size: 10px; font-weight: 700;">${opportunity.toFixed(0)}</div>
                        </div>
                        
                        <div style="margin-bottom: 12px; padding-right: 100px;">
                            <strong style="color: #60a5fa; font-size: 13px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                ${product.title || 'Product'}
                            </strong>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; font-size: 12px;">
                            <div>
                                <div style="color: #94a3b8; font-size: 10px;">üí∞ Price</div>
                                <div style="color: #22c55e; font-weight: 600; font-size: 14px;">‚Çπ${price}</div>
                            </div>
                            <div>
                                <div style="color: #94a3b8; font-size: 10px;">üìä Rank</div>
                                <div style="color: ${rank === 'N/A' ? '#94a3b8' : '#e2e8f0'}; font-weight: 600;">${rank === 'N/A' ? 'N/A' : rank}</div>
                            </div>
                            <div>
                                <div style="color: #94a3b8; font-size: 10px;">‚≠ê Reviews</div>
                                <div style="color: #e2e8f0; font-weight: 600;">${reviews}</div>
                            </div>
                            <div>
                                <div style="color: #94a3b8; font-size: 10px;">üë• Sellers</div>
                                <div style="color: ${sellers < 3 ? '#22c55e' : sellers < 6 ? '#f59e0b' : '#ef4444'}; font-weight: 600;">${sellers}</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 12px; padding: 8px; background: #0f172a; border-radius: 6px;">
                            <div style="color: #94a3b8; font-size: 9px;">ASIN</div>
                            <div style="color: #cbd5e1; font-family: monospace; font-size: 11px; font-weight: 600;">${product.asin}</div>
                        </div>

                        <div style="margin-bottom: 8px; padding: 8px; background: #0f172a; border-radius: 6px; font-size: 11px;">
                            <div style="color: #94a3b8;">üì¶ FBA:</div>
                            <div style="color: #e2e8f0; font-weight: 600;">${product.fba_percent}% sellers use FBA</div>
                        </div>

                        <button onclick="addToShortlist('${product.asin}', '${product.title.replace(/'/g, "\\'")}', ${price})" style="width: 100%; padding: 8px; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: 600; font-size: 12px; cursor: pointer; transition: all 0.2s; margin-bottom: 8px;">
                            ‚ûï Add to Shortlist
                        </button>

                        <a href="https://www.amazon.in/s?k=${product.asin}" target="_blank" style="display: block; padding: 8px; background: transparent; color: #60a5fa; border: 1px solid #60a5fa; border-radius: 6px; font-weight: 600; font-size: 12px; cursor: pointer; text-decoration: none; text-align: center;">
                            üîç View on Amazon
                        </a>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Add to shortlist
        function addToShortlist(asin, title, price) {
            let shortlist = JSON.parse(localStorage.getItem('shortlist') || '[]');
            
            // Check if already in shortlist
            if (shortlist.some(p => p.asin === asin)) {
                alert('Already in shortlist!');
                return;
            }

            // Check if we have 5 items already
            if (shortlist.length >= 5) {
                alert('Maximum 5 products in shortlist. Remove one to add more.');
                return;
            }

            shortlist.push({
                asin,
                title: title.substring(0, 50),
                price,
                added_at: new Date().toISOString()
            });

            localStorage.setItem('shortlist', JSON.stringify(shortlist));
            alert(`‚úÖ Added to shortlist (${shortlist.length}/5)`);
            
            // Update tab count
            updateShortlistCount();
        }

        // Update shortlist tab count
        function updateShortlistCount() {
            const shortlist = JSON.parse(localStorage.getItem('shortlist') || '[]');
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                if (tab.textContent.includes('Shortlist')) {
                    tab.innerHTML = `üéÅ My Shortlist (${shortlist.length})`;
                }
            });
        }

        // Initialize shortlist count on page load
        updateShortlistCount();

        // Load and display shortlist
        function loadShortlist() {
            const shortlist = JSON.parse(localStorage.getItem('shortlist') || '[]');
            const sourcingTab = document.getElementById('sourcingTab');

            if (!shortlist || shortlist.length === 0) {
                sourcingTab.innerHTML = `
                    <div class="card">
                        <h2>My Sourcing Shortlist</h2>
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <h3>No Products Shortlisted Yet</h3>
                            <p>Click on a category in Recommendations to explore products</p>
                        </div>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="card">
                    <h2>My Sourcing Shortlist (${shortlist.length}/5)</h2>
                    <p style="color: #94a3b8; margin-bottom: 20px; font-size: 14px;">
                        Selected products for wholesale sourcing analysis
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px;">
            `;

            shortlist.forEach((product, index) => {
                const addedDate = new Date(product.added_at).toLocaleDateString();
                html += `
                    <div style="background: #1e293b; border-radius: 12px; padding: 16px; border: 2px solid #2563eb; position: relative;">
                        <div style="position: absolute; top: 12px; right: 12px;">
                            <button onclick="removeFromShortlist('${product.asin}')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">‚úï Remove</button>
                        </div>

                        <div style="margin-bottom: 12px; padding-right: 100px;">
                            <strong style="color: #60a5fa; font-size: 13px; line-height: 1.5;">
                                ${product.title}
                            </strong>
                            <div style="font-size: 10px; color: #94a3b8; margin-top: 8px;">
                                ASIN: <span style="color: #cbd5e1; font-family: monospace;">${product.asin}</span>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            <div style="background: #0f172a; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="color: #94a3b8; font-size: 11px; margin-bottom: 4px;">PRICE</div>
                                <div style="color: #22c55e; font-weight: 600; font-size: 16px;">‚Çπ${product.price}</div>
                            </div>
                            <div style="background: #0f172a; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="color: #94a3b8; font-size: 11px; margin-bottom: 4px;">ADDED</div>
                                <div style="color: #cbd5e1; font-weight: 600; font-size: 12px;">${addedDate}</div>
                            </div>
                        </div>

                        <a href="https://www.amazon.in/s?k=${encodeURIComponent(product.asin)}" target="_blank" style="display: block; padding: 8px; background: #2563eb; color: white; border: none; border-radius: 6px; text-align: center; text-decoration: none; font-weight: 600; font-size: 12px; cursor: pointer; margin-bottom: 8px;">
                            üîç View on Amazon
                        </a>

                        <div style="padding: 12px; background: #0f172a; border-radius: 6px; font-size: 11px;">
                            <div style="color: #94a3b8; margin-bottom: 4px;"><strong>Next Steps:</strong></div>
                            <ul style="color: #cbd5e1; margin-left: 16px;">
                                <li>Check current price & reviews</li>
                                <li>Find wholesale supplier</li>
                                <li>Calculate profit margin</li>
                                <li>Verify supplier credibility</li>
                            </ul>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
                <div class="card" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 16px;">üí∞ Profit Calculator</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; color: #94a3b8; font-size: 12px; margin-bottom: 4px;">Retail Price (‚Çπ)</label>
                            <input id="retailPrice" type="number" placeholder="1000" style="width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: #e2e8f0; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; color: #94a3b8; font-size: 12px; margin-bottom: 4px;">Wholesale Cost (‚Çπ)</label>
                            <input id="wholesaleCost" type="number" placeholder="400" style="width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: #e2e8f0; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; color: #94a3b8; font-size: 12px; margin-bottom: 4px;">Monthly Sales (units)</label>
                            <input id="monthlySales" type="number" placeholder="50" style="width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: #e2e8f0; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; color: #94a3b8; font-size: 12px; margin-bottom: 4px;">Fulfillment Cost (‚Çπ)</label>
                            <input id="fulfillmentCost" type="number" placeholder="50" style="width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: #e2e8f0; font-size: 14px;">
                        </div>
                    </div>
                    <button onclick="calculateProfit()" style="width: 100%; margin-top: 16px; padding: 12px; background: #22c55e; color: black; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px;">
                        üí° Calculate Profit
                    </button>
                    <div id="profitResult" style="margin-top: 16px; padding: 16px; background: #0f172a; border-radius: 6px; display: none;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                            <div>
                                <div style="color: #94a3b8; font-size: 11px;">Per Unit</div>
                                <div id="profitPerUnit" style="color: #22c55e; font-weight: 600; font-size: 20px;">-</div>
                            </div>
                            <div>
                                <div style="color: #94a3b8; font-size: 11px;">Margin %</div>
                                <div id="marginPercent" style="color: #60a5fa; font-weight: 600; font-size: 20px;">-</div>
                            </div>
                            <div>
                                <div style="color: #94a3b8; font-size: 11px;">Monthly Profit</div>
                                <div id="monthlyProfit" style="color: #22c55e; font-weight: 600; font-size: 20px;">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            sourcingTab.innerHTML = html;
        }

        // Remove from shortlist
        function removeFromShortlist(asin) {
            let shortlist = JSON.parse(localStorage.getItem('shortlist') || '[]');
            shortlist = shortlist.filter(p => p.asin !== asin);
            localStorage.setItem('shortlist', JSON.stringify(shortlist));
            updateShortlistCount();
            loadShortlist(); // Reload display
        }

        // Calculate profit
        function calculateProfit() {
            const retailPrice = parseFloat(document.getElementById('retailPrice').value) || 0;
            const wholesaleCost = parseFloat(document.getElementById('wholesaleCost').value) || 0;
            const monthlySales = parseFloat(document.getElementById('monthlySales').value) || 0;
            const fulfillmentCost = parseFloat(document.getElementById('fulfillmentCost').value) || 0;

            if (!retailPrice || !wholesaleCost || !monthlySales) {
                alert('Please fill in all fields');
                return;
            }

            const profitPerUnit = retailPrice - wholesaleCost - fulfillmentCost;
            const marginPercent = ((profitPerUnit / retailPrice) * 100).toFixed(1);
            const monthlyProfit = (profitPerUnit * monthlySales).toFixed(0);

            document.getElementById('profitResult').style.display = 'block';
            document.getElementById('profitPerUnit').textContent = `‚Çπ${profitPerUnit.toFixed(0)}`;
            document.getElementById('marginPercent').textContent = `${marginPercent}%`;
            document.getElementById('monthlyProfit').textContent = `‚Çπ${parseInt(monthlyProfit).toLocaleString()}`;
        }

        // Auto-load on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadCategoryData();
        });
    </script>
</body>
</html>
